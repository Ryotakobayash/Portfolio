---
import { ClientRouter } from 'astro:transitions';
import '../styles/global.css';

interface Props {
  title?: string;
  description?: string;
}

const {
  title = 'Dashboard Portfolio',
  description = 'ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å‹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚µã‚¤ãƒˆ',
} = Astro.props;

// Google Analytics 4 Measurement ID
const GA_MEASUREMENT_ID = 'G-3XG4W5WQD1';
const GTM_ID = 'GTM-WG6RHC88';
---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <meta name="description" content={description} />
    <title>{title}</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="alternate" type="application/rss+xml" title="Dashboard Portfolio RSS" href="/rss.xml" />
    <ClientRouter />

    <!-- Dark mode script (run before render to prevent flash) -->
    <script is:inline>
      (function() {
        const theme = localStorage.getItem('theme') ||
          (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
      })();
    </script>

    <!-- Google Analytics 4 -->
    <script is:inline define:vars={{ GA_MEASUREMENT_ID }}>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', GA_MEASUREMENT_ID);
    </script>
    <script async src={`https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`}></script>

    <!-- Google Tag Manager -->
    <script is:inline define:vars={{ GTM_ID }}>
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer',GTM_ID);
    </script>
  </head>
  <body>
    <!-- GTM noscript -->
    <noscript>
      <iframe
        src={`https://www.googletagmanager.com/ns.html?id=${GTM_ID}`}
        height="0"
        width="0"
        style="display:none;visibility:hidden"
      ></iframe>
    </noscript>

    <header class="header">
      <div class="container header-content">
        <a href="/" class="logo">ğŸ“Š Dashboard Portfolio</a>
        <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode">
          <span class="sun-icon">â˜€ï¸</span>
          <span class="moon-icon">ğŸŒ™</span>
        </button>
      </div>
    </header>

    <main class="main">
      <div class="container">
        <slot />
      </div>
    </main>

    <script>
      function initTheme() {
        const theme = localStorage.getItem('theme') ||
          (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
      }

      function setupThemeToggle() {
        const toggle = document.getElementById('theme-toggle');
        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®é‡è¤‡é˜²æ­¢ï¼‰ã¯AstroãŒè¦ç´ ç½®æ›ã™ã‚‹ãŸã‚åŸºæœ¬çš„ã«ä¸è¦ã ãŒã€
        // å¿µã®ãŸã‚æ–°ã—ã„è¦ç´ ã«å¯¾ã—ã¦ã®ã¿ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹å½¢ã«ãªã‚‹ã€‚
        toggle?.addEventListener('click', () => {
          const current = document.documentElement.getAttribute('data-theme');
          const next = current === 'dark' ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', next);
          localStorage.setItem('theme', next);
        });
      }

      // åˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      // astro:page-load ã¯åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã¨ãƒšãƒ¼ã‚¸é·ç§»å¾Œã«ç™ºç«ã™ã‚‹
      document.addEventListener('astro:page-load', () => {
        setupThemeToggle();
      });

      // astro:after-swap ã¯æ–°ã—ã„HTMLã«å…¥ã‚Œæ›¿ã‚ã£ãŸç›´å¾Œï¼ˆè¡¨ç¤ºå‰ï¼‰ã«ç™ºç«
      // ã“ã“ã§ãƒ†ãƒ¼ãƒã‚’å†é©ç”¨ã—ãªã„ã¨ã€ä¸€ç¬ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒã«æˆ»ã‚‹ãƒãƒ©ã¤ãã‚„ã€å±æ€§æ¶ˆå¤±ã«ã‚ˆã‚‹ã‚¢ã‚¤ã‚³ãƒ³é‡è¤‡ãŒèµ·ãã‚‹
      document.addEventListener('astro:after-swap', () => {
        initTheme();
      });
    </script>

    <!-- Vercel Speed Insights -->
    <script is:inline>
      window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
    </script>
    <script async defer src="/_vercel/speed-insights/script.js"></script>

    <!-- Vercel Analytics -->
    <script is:inline>
      window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script async defer src="/_vercel/insights/script.js"></script>
  </body>
</html>
