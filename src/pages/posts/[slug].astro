---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import StickyToc from '../../components/StickyToc';
import CodeCopyButton from '../../components/CodeCopyButton';
import ImageZoom from '../../components/ImageZoom';
import ArticlePerformance from '../../components/ArticlePerformance';
import ShareButtons from '../../components/ShareButtons';
import RelatedPosts from '../../components/RelatedPosts';

export const prerender = true;

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => ({
    params: { slug: post.id.replace(/\.mdx?$/, '') },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'posts'>;
}

const { post } = Astro.props;
const slug = post.id.replace(/\.mdx?$/, '');
const { Content, headings } = await post.render();

// Ë™≠‰∫ÜÊôÇÈñì„ÇíÊé®ÂÆöÔºàÊó•Êú¨Ë™û„ÅØ1ÂàÜ„ÅÇ„Åü„ÇäÁ¥Ñ500ÊñáÂ≠ó„ÄÅËã±Ë™û„ÅØ200Ë™ûÔºâ
const body = post.body || '';
const charCount = body.length;
const readingTime = Math.max(1, Math.ceil(charCount / 500));

// TOCÁî®„Å´headings„Çí„Éï„Ç©„Éº„Éû„ÉÉ„Éà
const toc = headings
  .filter((h) => h.depth >= 2 && h.depth <= 3)
  .map((h) => ({
    id: h.slug,
    text: h.text,
    level: h.depth,
  }));

// Èñ¢ÈÄ£Ë®ò‰∫ãÁî®„Å´ÂÖ®Ë®ò‰∫ã„É°„Çø„Éá„Éº„Çø„ÇíÂèñÂæó
const allPosts = await getCollection('posts');
const allPostsMeta = allPosts.map((p) => ({
  slug: p.id.replace(/\.mdx?$/, ''),
  title: p.data.title,
  tags: p.data.tags || [],
  date: p.data.date,
}));
---

<BaseLayout
  title={`${post.data.title} | Dashboard Portfolio`}
  ogImage={`/og/${slug}.png`}
>
  <div class="article-layout">
    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <article class="article">
      <header class="article-header">
        <a href="/posts" class="back-link">‚Üê Ë®ò‰∫ã‰∏ÄË¶ß„Å´Êàª„Çã</a>
        <h1 class="article-title">{post.data.title}</h1>
        <div class="article-meta">
          <span>üìÖ {post.data.date}</span>
        </div>
        {post.data.tags && post.data.tags.length > 0 && (
          <div class="article-tags">
            {post.data.tags.map((tag: string) => (
              <a href={`/tags/${tag.replace(/\//g, '-')}`} class="badge">{tag}</a>
            ))}
          </div>
        )}
      </header>

      <ArticlePerformance
        client:load
        slug={slug}
        wordCount={charCount}
        readingTime={readingTime}
        publishDate={post.data.date}
      />

      <!-- „É¢„Éê„Ç§„É´Áî®TOC -->
      {toc.length > 0 && (
        <nav class="mobile-toc">
          <h2 class="mobile-toc-title">ÁõÆÊ¨°</h2>
          <ul class="mobile-toc-list">
            {toc.map((item) => (
              <li style={`padding-left: ${(item.level - 2) * 1}rem`}>
                <a href={`#${item.id}`}>{item.text}</a>
              </li>
            ))}
          </ul>
        </nav>
      )}

      <div class="prose">
        <Content />
      </div>

      <!-- Ë®ò‰∫ã„Éï„ÉÉ„Çø„Éº -->
      <footer class="article-footer">
        <ShareButtons
          client:load
          title={post.data.title}
          url={`https://dashboard-portfolio.vercel.app/posts/${slug}`}
        />
        <RelatedPosts
          client:load
          currentSlug={slug}
          currentTags={post.data.tags || []}
          allPosts={allPostsMeta}
        />
      </footer>

      <!-- „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Çµ„Ç§„ÉâÊ©üËÉΩ -->
      <CodeCopyButton client:load />
      <ImageZoom client:load />
    </article>

    <!-- „Çµ„Ç§„Éâ„Éê„ÉºTOCÔºà„Éá„Çπ„ÇØ„Éà„ÉÉ„ÉóÔºâ -->
    {toc.length > 0 && (
      <aside class="sidebar">
        <StickyToc client:load toc={toc} />
      </aside>
    )}
  </div>
</BaseLayout>

<style>
  .article-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-xl);
    max-width: 1100px;
    margin: 0 auto;
  }

  @media (min-width: 1024px) {
    .article-layout {
      grid-template-columns: 1fr 280px;
    }
  }

  .article {
    min-width: 0;
  }

  .sidebar {
    display: none;
  }

  @media (min-width: 1024px) {
    .sidebar {
      display: block;
    }
  }

  .article-header {
    margin-bottom: var(--spacing-xl);
  }

  .back-link {
    display: inline-block;
    font-size: 0.875rem;
    color: var(--color-primary);
    margin-bottom: var(--spacing-lg);
  }

  .article-title {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1.3;
    margin-bottom: var(--spacing-md);
  }

  .article-meta {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-md);
  }

  .meta-separator {
    color: var(--color-text-muted);
  }

  .article-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-xs);
  }

  /* „É¢„Éê„Ç§„É´TOC */
  .mobile-toc {
    background-color: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-xl);
  }

  @media (min-width: 1024px) {
    .mobile-toc {
      display: none;
    }
  }

  .mobile-toc-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-sm);
  }

  .mobile-toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .mobile-toc-list li {
    margin-bottom: var(--spacing-xs);
  }

  .mobile-toc-list a {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    text-decoration: none;
  }

  .mobile-toc-list a:hover {
    color: var(--color-primary);
  }

  /* Prose styles for Markdown content */
  .prose {
    line-height: 1.8;
  }

  .prose :global(h2) {
    font-size: 1.5rem;
    font-weight: 700;
    margin-top: 2rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--color-border);
  }

  .prose :global(h3) {
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }

  .prose :global(p) {
    margin-bottom: 1rem;
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
  }

  .prose :global(li) {
    margin-bottom: 0.5rem;
  }

  .prose :global(a) {
    color: var(--color-primary);
    text-decoration: underline;
  }

  .prose :global(code) {
    background-color: var(--color-bg-secondary);
    padding: 0.125rem 0.375rem;
    border-radius: var(--radius-sm);
    font-size: 0.875em;
  }

  .prose :global(pre) {
    background-color: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    overflow-x: auto;
    margin-bottom: 1rem;
  }

  .prose :global(pre code) {
    background: none;
    padding: 0;
    font-size: 0.875rem;
  }

  .prose :global(blockquote) {
    border-left: 4px solid var(--color-accent);
    padding-left: var(--spacing-md);
    margin: 1rem 0;
    color: var(--color-text-secondary);
  }

  .prose :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    margin: 1rem 0;
  }

  .prose :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
  }

  .prose :global(th),
  .prose :global(td) {
    border: 1px solid var(--color-border);
    padding: var(--spacing-sm) var(--spacing-md);
    text-align: left;
  }

  .prose :global(th) {
    background-color: var(--color-bg-secondary);
    font-weight: 600;
  }
</style>
