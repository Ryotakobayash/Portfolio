---
export const prerender = true;
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import PVChart from '../components/PVChart';
import PostCalendar from '../components/PostCalendar';
import PopularPosts from '../components/PopularPosts';
import GitHubActivity from '../components/GitHubActivity';

// å…¨è¨˜äº‹ã‚’å–å¾—
const posts = await getCollection('posts');
const sortedPosts = posts
  .map((post) => ({
    slug: post.id.replace(/\.mdx?$/, ''),
    title: post.data.title,
    date: post.data.date,
    tags: post.data.tags || [],
  }))
  .sort((a, b) => (a.date < b.date ? 1 : -1));

const postCount = posts.length;
---

<BaseLayout>
  <div class="bento-grid">
    <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ -->
    <div class="bento-card">
      <div class="bento-card__title">Profile</div>
      <div class="flex items-center gap-lg">
        <div class="avatar">KR</div>
        <div class="flex flex-col gap-sm">
          <span class="text-lg font-bold">å°æ— è«’å¤§</span>
          <span class="text-secondary text-sm">Cybozu ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼</span>
        </div>
      </div>
      <div class="card-footer">
        <a href="/about" class="link-arrow">è©³ç´°ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« â†’</a>
      </div>
    </div>

    <!-- PVæ•°ã‚°ãƒ©ãƒ•ã‚«ãƒ¼ãƒ‰ï¼ˆãƒ¯ã‚¤ãƒ‰ï¼‰ -->
    <div class="bento-card bento-card--wide">
      <div class="bento-card__title">Page Views (Last 7 Days)</div>
      <PVChart client:only="react" />
    </div>

    <!-- æŠ•ç¨¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚«ãƒ¼ãƒ‰ï¼ˆãƒ¯ã‚¤ãƒ‰ï¼‰ -->
    <div class="bento-card bento-card--wide">
      <div class="bento-card__title">Post Activity</div>
      <PostCalendar
        client:load
        posts={sortedPosts.map((p) => ({ slug: p.slug, title: p.title, date: p.date }))}
      />
    </div>

    <!-- GitHub Activity ã‚«ãƒ¼ãƒ‰ -->
    <div class="bento-card bento-card--wide">
      <div class="bento-card__title">GitHub Activity</div>
      <GitHubActivity client:load />
    </div>

    <!-- äººæ°—è¨˜äº‹ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ -->
    <div class="bento-card">
      <div class="bento-card__title">Popular Posts (30 Days)</div>
      <PopularPosts client:load />
    </div>

    <!-- æœ€æ–°è¨˜äº‹ãƒªã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ -->
    <div class="bento-card">
      <div class="bento-card__title">Latest Posts</div>
      <div class="post-list">
        {sortedPosts.length > 0 ? (
          sortedPosts.slice(0, 3).map((post) => (
            <a href={`/posts/${post.slug}`} class="post-list__item">
              <span class="post-list__icon">ğŸ“</span>
              <div class="post-list__content">
                <span class="post-list__title">{post.title}</span>
                <span class="post-list__date">{post.date}</span>
              </div>
            </a>
          ))
        ) : (
          <p class="text-muted text-sm">ã¾ã è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</p>
        )}
      </div>
      <div class="card-footer flex justify-between items-center">
        <span class="text-muted text-sm">Total: {postCount} posts</span>
        <a href="/posts" class="link-arrow">ã™ã¹ã¦è¦‹ã‚‹ â†’</a>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .card-footer {
    margin-top: auto;
    padding-top: var(--spacing-md);
  }

  .post-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .post-list__item {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: inherit;
    transition: background-color var(--transition-fast);
  }

  .post-list__item:hover {
    background-color: var(--color-bg-secondary);
  }

  .post-list__icon {
    flex-shrink: 0;
  }

  .post-list__content {
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
  }

  .post-list__title {
    font-size: 0.875rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .post-list__date {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }
</style>
